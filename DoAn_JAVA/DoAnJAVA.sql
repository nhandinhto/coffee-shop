CREATE DATABASE DEAN_JAVA
USE DEAN_JAVA


GO
--========== BẢNG CHỨC VỤ ==========--
CREATE TABLE CHUCVU
(
	MACV NVARCHAR(10),	
	TENCHUCVU NVARCHAR(50),	
	LUONGCB INT,
	HSL FLOAT,
	CONSTRAINT PK_CV PRIMARY KEY(MACV)	
)

--========== BẢNG NHÂN VIÊN ==========--
CREATE TABLE NHANVIEN
(
	MANV NVARCHAR(10) NOT NULL,
	HOTENNV NVARCHAR(50),
	NGAYSINH DATE,
	DIACHI NVARCHAR(50),
	GIOITINH NVARCHAR(10),
	CA INT,
	MACV NVARCHAR(10),
	CONSTRAINT PK_NV PRIMARY KEY(MANV),
	CONSTRAINT FK_NV_CHUCVU FOREIGN KEY(MACV) REFERENCES CHUCVU(MACV)
)

--========== BẢNG KHÁCH HÀNG ==========--
CREATE TABLE KHACHHANG
(
	MAKH NVARCHAR(10) NOT NULL,
	HOTENKH NVARCHAR(50),
	GIOITINH NVARCHAR(10),
	CONSTRAINT PK_KH PRIMARY KEY(MAKH)
)

--========== BẢNG THỨC UỐNG ==========--
CREATE TABLE THUCUONG
(
	MATU NVARCHAR(10) NOT NULL,
	TENTU NVARCHAR(50),
	SOLUONG INT,
	TINHTRANG NVARCHAR(50),
	DONGIA float,
	CONSTRAINT PK_TU PRIMARY KEY(MATU)
)
--========== BẢNG ĐIỂM TÂM ==========--
CREATE TABLE DIEMTAM
(
	MADT NVARCHAR(10) NOT NULL,
	TENDT NVARCHAR(50),
	SOLUONG INT,
	TINHTRANG NVARCHAR(50),
	DONGIA float,
	CONSTRAINT PK_DT PRIMARY KEY(MADT)
)
--===== BẢNG BÀN=====-
CREATE TABLE BAN
(
	MABAN VARCHAR(11) NOT NULL,
	SLKHACH INT,
	PRIMARY KEY(MABAN)
)


--========== BẢNG HÓA ĐƠN ==========--
CREATE TABLE HOADON
(
	MAHD NVARCHAR(10) NOT NULL,
	MAKH NVARCHAR(10),
	MABAN VARCHAR(11) NOT NULL,
	NGAYLAP DATE,
	TIENBAN INT,
	GIAMGIA FLOAT,
	THANHTIEN INT,
	MANV NVARCHAR(10),
	CONSTRAINT PK_HD PRIMARY KEY(MAHD),
	CONSTRAINT FK_KH FOREIGN KEY(MAKH) REFERENCES KHACHHANG(MAKH),
	CONSTRAINT FK_NV FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV),
	CONSTRAINT FK_BAN FOREIGN KEY(MABAN) REFERENCES BAN(MABAN)
)

--========== BẢNG CHI TIẾT HÓA ĐƠN THỨC UỐNG ==========--
CREATE TABLE CTHDTHUCUONG
(
	MAHD NVARCHAR(10),
	MATU NVARCHAR(10),
	SOLUONG INT,
	THANHTIEN INT,
	CONSTRAINT PK_CTTU PRIMARY KEY(MAHD,MATU),
	CONSTRAINT FK_CTTU_HD FOREIGN KEY(MAHD) REFERENCES HOADON(MAHD),
	CONSTRAINT FK_CTTU_TU FOREIGN KEY(MATU) REFERENCES THUCUONG(MATU)
)

--========== BẢNG CHI TIẾT HÓA ĐƠN ĐIỂM TÂM ==========--
CREATE TABLE CTHDDIEMTAM
(
	MAHD NVARCHAR(10),
	MADT NVARCHAR(10),
	SOLUONG INT,
	THANHTIEN INT,
	CONSTRAINT PK_CTDT PRIMARY KEY(MAHD,MADT),
	CONSTRAINT FK_CTT_HD FOREIGN KEY(MAHD) REFERENCES HOADON(MAHD),
	CONSTRAINT FK_CTTU_DT FOREIGN KEY(MADT) REFERENCES DIEMTAM(MADT)
)

--========== BẢNG LƯƠNG ==========--
CREATE TABLE LUONG
(
	MANV NVARCHAR(10),
	MACV NVARCHAR(10),	
	SONGAYNGHI INT,
	LUONGBITRU INT,
	THUONG INT,
	TROCAP INT,
	TONGLUONG INT,
	CONSTRAINT PK_LUONG PRIMARY KEY(MANV),
	CONSTRAINT FK_LUONG_NV FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV),
	CONSTRAINT FK_LUONG_CV FOREIGN KEY(MACV) REFERENCES CHUCVU(MACV)
)
--===== BẢNG KHO =====--
CREATE TABLE KHO
(
	MANL VARCHAR(11) NOT NULL,--MÃ NGUYÊN LIỆU
	TENNL NVARCHAR(51),
	GIA FLOAT,
	DVT NVARCHAR(21),
	SLNHAP INT,
	NGAYNHAP DATE,
	SLXUAT INT,
	NGAYXUAT DATE,
	MANV NVARCHAR(10) NOT NULL,
	PRIMARY KEY(MANL),
	CONSTRAINT FK_NHANVIEN FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)
)
CREATE TABLE HOADONKHO
(
	MAHDK VARCHAR(11) NOT NULL,
	MANL VARCHAR(11) NOT NULL,
	TONGTIEN INT, -- TONGTIEN = (SLXUAT-SLNHAP)*GIABAN
	PRIMARY KEY(MAHDK),
	CONSTRAINT FK_KHO FOREIGN KEY(MANL) REFERENCES KHO(MANL)

)

CREATE TABLE NGUOIDUNG
(
	TENDN VARCHAR(30) NOT NULL PRIMARY KEY,
	MK VARCHAR(11) NOT NULL,
	MANV NVARCHAR(10),
	CONSTRAINT FK_NHANVIEN_NGUOIDUNG FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)
)
INSERT INTO NGUOIDUNG 
VALUES
('nhan','123',N'NV003')
--==== NHẬP DỮ LIỆU CHO BẢNG BÀN====--
INSERT INTO BAN VALUES('MB001',4),
('MB002',1),
('MB003',2),
('MB004',5),
('MB005',7),
('MB006',3),
('MB007',1),
('MB008',9)
--===== NHẬP DỮ LIỆU CHO BẢNG CHỨC VỤ =====--
INSERT INTO CHUCVU VALUES
('CV001',N'NHÂN VIÊN',3500000,0.5)
INSERT INTO CHUCVU VALUES
('CV002',N'THU NGÂN',3000000,0.5)
INSERT INTO CHUCVU VALUES
('CV003',N'QUẢN LÍ',5000000,1.5)

--===== NHẬP DỮ LIỆU CHO BẢNG NHÂN VIÊN =====--
SET DATEFORMAT DMY
INSERT INTO NHANVIEN VALUES
('NV001',N'TRƯƠNG ĐÌNH LONG','12/08/1992',N'QUÃNG NGÃI',N'NAM',1,'CV001')
INSERT INTO NHANVIEN VALUES
('NV002',N'TRỊNH KIM ANH','24/06/1994',N'TRÀ VINH',N'NỮ',2,'CV002')
INSERT INTO NHANVIEN VALUES
('NV003',N'TÔ THỊ BÍCH TRÂN','07/02/1991',N'TP.HCM',N'NỮ',1,'CV002')
INSERT INTO NHANVIEN VALUES
('NV004',N'MAI CHÁNH TÂN','15/06/1990',N'TP.HCM',N'NAM',1,'CV003')
INSERT INTO NHANVIEN VALUES
('NV005',N'VÕ NGỌC HƯƠNG','09/03/1993',N'NINH BÌNH',N'NỮ',2,'CV001')
INSERT INTO NHANVIEN VALUES
('NV006',N'VÕ THỊ HỒNG THƯƠNG','26/01/1996',N'TP.HCM',N'NỮ',1,'CV001')
INSERT INTO NHANVIEN VALUES
('NV007',N'TÔ NGỌC LINH','06/12/1995',N'ĐẮK LẮK',N'NỮ',2,'CV003')
INSERT INTO NHANVIEN VALUES
('NV008',N'TRỊNH TẤN TÀI','15/10/1994',N'PHÚ YÊN',N'NAM',2,'CV001')

--===== NHẬP DỮ LIỆU CHO BẢNG KHÁCH HÀNG =====--
INSERT INTO KHACHHANG VALUES
('KH001',N'TÔ ĐÌNH NHÂN',N'NAM')
INSERT INTO KHACHHANG VALUES
('KH002',N'NGUYỄN HUY KHÔI NGUYÊN',N'NAM')
INSERT INTO KHACHHANG VALUES
('KH003',N'HUỲNH CÔNG ĐOÀN',N'NAM')
INSERT INTO KHACHHANG VALUES
('KH004',N'TRẦN MĨ LỆ',N'NỮ')
INSERT INTO KHACHHANG VALUES
('KH005',N'NGUYỄN THỊ XUÂN',N'NỮ')

--===== NHẬP DỮ LIỆU CHO BẢNG THỨC UỐNG =====--
INSERT INTO THUCUONG VALUES
('TU001',N'CÀ PHÊ ĐÁ',20,NULL,12000)
INSERT INTO THUCUONG VALUES
('TU002',N'CÀ PHÊ SỮA ĐÁ',18,NULL,15000)
INSERT INTO THUCUONG VALUES
('TU003',N'WARRIOR VỊ NHO',5,NULL,20000)
INSERT INTO THUCUONG VALUES
('TU004',N'PEPSI',36,NULL,18000)
INSERT INTO THUCUONG VALUES
('TU005',N'SINH TỐ DÂU',67,NULL,23000)
INSERT INTO THUCUONG VALUES
('TU006',N'SINH TỐ CAM',29,NULL,23000)
INSERT INTO THUCUONG VALUES
('TU007',N'TRÀ SỮA TRUYỀN THỐNG',150,NULL,25000)
INSERT INTO THUCUONG VALUES
('TU008',N'SỮA TƯƠI CHÂN TRÂU ĐƯỜNG ĐEN',16,NULL,35000)
INSERT INTO THUCUONG VALUES
('TU009',N'NƯỚC ÉP CHANH DÂY',45,NULL,22000)
INSERT INTO THUCUONG VALUES
('TU010',N'SODA CHANH',127,NULL,28000)


--===== NHẬP DỮ LIỆU CHO BẢNG ĐIỂM TÂM =====--
INSERT INTO DIEMTAM VALUES
('DT001',N'BÁNH PLAN',160,NULL,15000)
INSERT INTO DIEMTAM VALUES
('DT002',N'BÚN CHẢ CÁ',12,NULL,28000)
INSERT INTO DIEMTAM VALUES
('DT003',N'SPAGHETTI XỐT BÒ',135,NULL,20000)
INSERT INTO DIEMTAM VALUES
('DT004',N'BÁNH MÌ ỐP LA',210,NULL,10000)
INSERT INTO DIEMTAM VALUES
('DT005',N'BÁNH MÌ XÍU MẠI',150,NULL,10000)
INSERT INTO DIEMTAM VALUES
('DT006',N'BÁNH MÌ THỊT',83,NULL,10000)
INSERT INTO DIEMTAM VALUES
('DT007',N'BÚN BÒ',28,NULL,26000)


--===== NHẬP DỮ LIỆU CHO BẢNG HÓA ĐƠN =====--
SET DATEFORMAT DMY
INSERT INTO HOADON VALUES
('HD001','KH001','MB001','28/07/2019',NULL,NULL,NULL,'NV002')
INSERT INTO HOADON VALUES
('HD002','KH002','MB002','30/07/2019',NULL,NULL,NULL,'NV001')
INSERT INTO HOADON VALUES
('HD003','KH005','MB003','30/07/2019',NULL,NULL,NULL,'NV005')
INSERT INTO HOADON VALUES
('HD004','KH004','MB004','31/07/2019',NULL,NULL,NULL,'NV004')
INSERT INTO HOADON VALUES
('HD005','KH001','MB005','19/09/2019',NULL,NULL,NULL,'NV008')
INSERT INTO HOADON VALUES
('HD006','KH005','MB006','22/09/2019',NULL,NULL,NULL,'NV005')
INSERT INTO HOADON VALUES
('HD007','KH002','MB007','23/09/2019',NULL,NULL,NULL,'NV006')
INSERT INTO HOADON VALUES
('HD008','KH001','MB008','30/09/2019',NULL,NULL,NULL,'NV003')


--===== NHẬP DỮ LIỆU CHO BẢNG CHI TIẾT HÓA ĐƠN THỨC UỐNG =====--
INSERT INTO CTHDTHUCUONG VALUES
('HD001','TU001',1,NULL)
INSERT INTO CTHDTHUCUONG VALUES
('HD002','TU004',1,NULL)
INSERT INTO CTHDTHUCUONG VALUES
('HD002','TU002',2,NULL)
INSERT INTO CTHDTHUCUONG VALUES
('HD003','TU007',1,NULL)
INSERT INTO CTHDTHUCUONG VALUES
('HD003','TU008',1,NULL)
INSERT INTO CTHDTHUCUONG VALUES
('HD003','TU010',1,NULL)
INSERT INTO CTHDTHUCUONG VALUES
('HD004','TU006',3,NULL)
INSERT INTO CTHDTHUCUONG VALUES
('HD005','TU002',2,NULL)
INSERT INTO CTHDTHUCUONG VALUES
('HD006','TU004',3,NULL)
INSERT INTO CTHDTHUCUONG VALUES
('HD006','TU003',2,NULL)
INSERT INTO CTHDTHUCUONG VALUES
('HD007','TU001',6,NULL)
INSERT INTO CTHDTHUCUONG VALUES
('HD008','TU008',4,NULL)
INSERT INTO CTHDTHUCUONG VALUES
('HD008','TU010',5,NULL)


--===== NHẬP DỮ LIỆU CHO BẢNG CHI TIẾT HÓA ĐƠN ĐIỂM TÂM =====--
INSERT INTO CTHDDIEMTAM VALUES
('HD001','DT001',1,NULL)
INSERT INTO CTHDDIEMTAM VALUES
('HD003','DT004',2,NULL)
INSERT INTO CTHDDIEMTAM VALUES
('HD003','DT005',1,NULL)
INSERT INTO CTHDDIEMTAM VALUES
('HD004','DT003',3,NULL)
INSERT INTO CTHDDIEMTAM VALUES
('HD005','DT007',2,NULL)
INSERT INTO CTHDDIEMTAM VALUES
('HD006','DT006',1,NULL)
INSERT INTO CTHDDIEMTAM VALUES
('HD008','DT007',5,NULL)

--===== NHẬP DỮ LIỆU CHO BẢNG LƯƠNG =====--
INSERT INTO LUONG VALUES
('NV001','CV001',2,NULL,NULL,NULL,NULL)
INSERT INTO LUONG VALUES
('NV002','CV002',4,NULL,NULL,NULL,NULL)
INSERT INTO LUONG VALUES
('NV003','CV002',0,NULL,NULL,NULL,NULL)
INSERT INTO LUONG VALUES
('NV004','CV003',1,NULL,NULL,NULL,NULL)
INSERT INTO LUONG VALUES
('NV005','CV001',1,NULL,NULL,NULL,NULL)
INSERT INTO LUONG VALUES
('NV006','CV001',2,NULL,NULL,NULL,NULL)
INSERT INTO LUONG VALUES
('NV007','CV003',0,NULL,NULL,NULL,NULL)
INSERT INTO LUONG VALUES
('NV008','CV001',3,NULL,NULL,NULL,NULL)
--=== NHẬP DỮ LIỆU CHO BẢNG KHO===----
INSERT INTO KHO VALUES('NL001',N'CHANH',15000,N'KG',50,'01/05/2019',30,'01/06/2019','NV001'),
('NL002',N'CAFE',150000,N'KG',100,'01/05/2019',45,'01/06/2019','NV003'),
('NL003',N'CAM',10000,N'KG',48,'01/05/2019',41,'01/06/2019','NV001'),
('NL004',N'NƯỚC NGỌT',240000,N'THÙNG',15,'01/05/2019',10,'01/06/2019','NV003'),
('NL005',N'SỮA TƯƠI',150000,N'THÙNG',10,'01/05/2019',7,'01/06/2019','NV002'),
('NL006',N'DÂU',30000,N'KG',50,'01/05/2019',30,'01/06/2019','NV001')
--==== NHẬP DỮ LIỆU CHO BẢNGHOADONKHO
INSERT INTO HOADONKHO VALUES('HDK001','NL001',NULL),
('HDK002','NL002',NULL),
('HDK003','NL003',NULL),
('HDK004','NL004',NULL),
('HDK005','NL005',NULL),
('HDK006','NL006',NULL)

---------=========******* TRUY VẤN  *******=========---------
------====== 1. CẬP NHẬT THÀNH TIỀN TRONG BẢNG CTHDTU ======------
UPDATE CTHDTHUCUONG
SET THANHTIEN = CTHDTHUCUONG.SOLUONG * DONGIA
FROM THUCUONG
WHERE THUCUONG.MATU = CTHDTHUCUONG.MATU

SELECT * FROM THUCUONG
SELECT * FROM CTHDTHUCUONG

------====== 2. CẬP NHẬT THÀNH TIỀN TRONG BẢNG CTHDDT ======------
UPDATE CTHDDIEMTAM
SET THANHTIEN = CTHDDIEMTAM.SOLUONG * DONGIA
FROM DIEMTAM
WHERE DIEMTAM.MADT = CTHDDIEMTAM.MADT

SELECT * FROM DIEMTAM
SELECT * FROM CTHDDIEMTAM

------====== 3. CHO BIẾT NHỮNG NHÂN VIÊN NÀO DƯỚI 25 TUỔI ======------
SELECT NHANVIEN.*
FROM NHANVIEN
WHERE DATEDIFF(YEAR,NGAYSINH,GETDATE()) < 25

------====== 4. CHO BIẾT DANH SÁCH NHỮNG NHÂN VIÊN NỮ SỐNG TẠI TPHCM ======------
SELECT NHANVIEN.*
FROM NHANVIEN
WHERE DIACHI = 'TP.HCM' AND GIOITINH = N'NỮ'

------====== 5. CHO BIẾT DANH SÁCH CÁC NHÂN VIỄN QUẢN LÍ ======------
SELECT NHANVIEN.*
FROM NHANVIEN, CHUCVU
WHERE NHANVIEN.MACV = CHUCVU.MACV AND TENCHUCVU = N'QUẢN LÍ'

------====== 6. CHO BIẾT NHÂN VIÊN NÀO CÓ TUỔI LỚN NHẤT  ======------
SELECT NHANVIEN.*
FROM NHANVIEN
WHERE DATEDIFF(YEAR,NGAYSINH,GETDATE()) >=  ALL(SELECT DATEDIFF(YEAR,NGAYSINH,GETDATE()) FROM NHANVIEN)

------====== 7. CHO BIẾT NHÂN VIÊN NÀO CÓ TUỔI NHỎ NHẤT  ======------
SELECT TOP 1 NHANVIEN.*
FROM NHANVIEN
ORDER BY DATEDIFF(YEAR,NGAYSINH,GETDATE()) ASC

------===============TRUY VẤN KẾT THÚC Ở ĐÂY==================------------------------
---------=========******* RÀNG BUỘC TOÀN VẸN  *******=========---------
------====== 1. GIỚI TÍNH CỦA KHÁCH HÀNG VÀ NHÂN VIÊN PHẢI LÀ NAM HOẶC NỮ ======------
ALTER TABLE NHANVIEN
	ADD CONSTRAINT CHECK_GT_NV CHECK(GIOITINH = N'NAM' OR GIOITINH = N'NỮ')
ALTER TABLE KHACHHANG
	ADD CONSTRAINT CHECK_GT_KH CHECK(GIOITINH = N'NAM' OR GIOITINH = N'NỮ')

---TEST BẢNG NHANVIEN---
SET DATEFORMAT DMY
INSERT INTO NHANVIEN VALUES
('NV009',N'TRẦN ĐÌNH','12/08/1992',N'QUÃNG NGÃI',N'KHÁC',1,'CV001')

UPDATE NHANVIEN
SET GIOITINH = N'KHÁC'
WHERE MANV = 'NV001'

---TEST BẢNG KHACHHANG---
INSERT INTO KHACHHANG VALUES
('KH006',N'TÔ ĐÌNH',N'KHÁC')

UPDATE KHACHHANG
SET GIOITINH = N'KHÁC'
WHERE MAKH = 'KH001'

------====== 2. TÊN CHỨC VỤ, ĐIỂM TÂM, THỨC UỐNG PHẢI LÀ DUY NHẤT ======------
ALTER TABLE CHUCVU
	ADD CONSTRAINT UNI_CV UNIQUE(TENCHUCVU)
ALTER TABLE DIEMTAM
	ADD CONSTRAINT UNI_DT UNIQUE(TENDT)
ALTER TABLE THUCUONG
	ADD CONSTRAINT UNI_TU UNIQUE(TENTU)

---TEST BẢNG CHUCVU---
INSERT INTO CHUCVU VALUES
('CV004',N'NHÂN VIÊN',3500000,0.5)

UPDATE CHUCVU
SET TENCHUCVU = N'THU NGÂN'
WHERE MACV = 'CV001'

---TEST BẢNG DIEMTAM---
INSERT INTO DIEMTAM VALUES
('DT008',N'BÁNH PLAN',160,NULL,15000)

UPDATE DIEMTAM
SET TENDT = N'BÚN CHẢ CÁ'
WHERE MADT = 'DT001'

---TEST BẢNG THUCUONG---
INSERT INTO THUCUONG VALUES
('TU011',N'CÀ PHÊ ĐÁ',20,NULL,12000)

UPDATE THUCUONG
SET TENTU = N'CÀ PHÊ SỮA ĐÁ'
WHERE MATU = 'TU001'

------====== 3. GIÁ CỦA THỨC UỐNG VÀ ĐIỂM TÂM PHẢI LỚN HƠN 0 ======------
ALTER TABLE THUCUONG
	ADD CONSTRAINT CHECK_GIA_TU CHECK(DONGIA >0)
ALTER TABLE DIEMTAM
	ADD CONSTRAINT CHECK_GIA_DT CHECK(DONGIA >0)

---TEST BẢNG THUCUONG---
INSERT INTO THUCUONG VALUES
('TU011',N'CÀ PHÊ TRẮNG',20,NULL,-12000)

UPDATE THUCUONG
SET DONGIA = -12000
WHERE MATU = 'TU001'

---TEST BẢNG DIEMTAM---
INSERT INTO DIEMTAM VALUES
('DT008',N'BÁNH PLAN NÂU',160,NULL,-15000)

UPDATE DIEMTAM
SET DONGIA = -12200
WHERE MADT = 'DT001'

------====== 4. SỐ LƯỢNG TRONG BẢNG CTHDTHUCUONG, CTHDDIEMTAM PHẢI LỚN HƠN 0 ======------
ALTER TABLE CTHDDIEMTAM
	ADD CONSTRAINT CHECK_SL_CTDT CHECK(SOLUONG > 0)
ALTER TABLE CTHDTHUCUONG
	ADD CONSTRAINT CHECK_SL_CTTU CHECK(SOLUONG > 0)

---TEST BẢNG CTHDDIEMTAM---
INSERT INTO CTHDDIEMTAM VALUES
('HD001','DT002',-1,NULL)

UPDATE CTHDDIEMTAM
SET SOLUONG = -1 
WHERE MAHD = 'HD001' AND MADT = 'DT001'

---TEST BẢNG CTHDTHUCUONG---
INSERT INTO CTHDTHUCUONG VALUES
('HD001','TU002',-1,NULL)

UPDATE CTHDTHUCUONG
SET SOLUONG = -1 
WHERE MAHD = 'HD001' AND MATU = 'TU001'

------====== 5. CA CỦA NHÂN VIÊN LÀM LÀ 1 HOẶC 2 ======------
ALTER TABLE NHANVIEN
	ADD CONSTRAINT CHECK_CA_NV CHECK(CA = 1 OR CA = 2)

---TEST BẢNG NHANVIEN---
SET DATEFORMAT DMY
INSERT INTO NHANVIEN VALUES
('NV009',N'TRƯƠNG ĐÌNH LONG','12/08/1992',N'QUÃNG NGÃI',N'NAM',3,'CV001')

UPDATE NHANVIEN
SET CA = 0
WHERE MANV = 'NV001'

------====== 6. HỆ SỐ LƯƠNG PHẢI LỚN HƠN 0 ======------
ALTER TABLE CHUCVU
	ADD CONSTRAINT CHECK_HSL_CV CHECK(HSL > 0)

---TEST BẢNG CHUCVU---
INSERT INTO CHUCVU VALUES
('CV004',N'NHÂN VIÊN A',3500000,0)

UPDATE CHUCVU
SET HSL = -0.5
WHERE MACV = 'CV001'

------====== 7. ĐỘ TUỔI CỦA NHÂN VIÊN PHẢI LỚN HƠN 18 ======------
CREATE TRIGGER CHECKTUOINHANVIEN
ON NHANVIEN
FOR INSERT, UPDATE
AS
	DECLARE @NGAYSINH DATE
	SET @NGAYSINH = (SELECT NGAYSINH FROM INSERTED)
	IF(DATEDIFF(YEAR,@NGAYSINH,GETDATE())) <= 18
	BEGIN
		PRINT N'ĐỘ TUỔI CỦA NHÂN VIÊN PHẢI LỚN HƠN 18'
		ROLLBACK TRAN
	END
GO

---TEST BẢNG NHANVIEN---
SET DATEFORMAT DMY
INSERT INTO NHANVIEN VALUES
('NV009',N'TRƯƠNG ĐÌNH','12/08/2008',N'QUÃNG NGÃI',N'NAM',1,'CV001')

UPDATE NHANVIEN
SET NGAYSINH = '20/06/2005'
WHERE MANV = 'NV001'

------====== 8. SỐ NGÀY NGHỈ KHÔNG ĐƯỢC VƯỢT QUÁ 4 ======------
ALTER TABLE LUONG
	ADD CONSTRAINT CHECK_SNN CHECK(SONGAYNGHI <= 4)

---TEST BẢNG LUONG---
INSERT INTO LUONG VALUES
('NV008','CV001',5,NULL,NULL,NULL,NULL)

UPDATE LUONG
SET SONGAYNGHI = 5
WHERE MANV = 'NV008'

------====== 9. CẬP NHẬT SOLUONG LẠI CHO BẢNG THỨC UỐNG MỖI KHI THỨC UỐNG ĐƯỢC BÁN RA (THÊM, SỬA DỮ LIỆU VÀO CTHDTHUCUONG) ======------
------INSERT------
CREATE TRIGGER CAPNHATSOLUONGTHUCUONG1
ON CTHDTHUCUONG
FOR INSERT
AS
	DECLARE @SL INT 
	SET @SL = (SELECT SOLUONG FROM INSERTED)
	UPDATE THUCUONG
	SET SOLUONG = THUCUONG.SOLUONG - @SL
	FROM INSERTED
	WHERE THUCUONG.MATU = INSERTED.MATU
GO

---TEST BẢNG CTHDTU---
INSERT INTO THUCUONG VALUES
('TU015',N'SODA Cam',127,NULL,28000)

INSERT INTO CTHDTHUCUONG VALUES
('HD0010','TU017',3,NULL)

SELECT * FROM THUCUONG
SELECT * FROM CTHDTHUCUONG

------UPDATE------
CREATE TRIGGER CAPNHATSOLUONGTHUCUONG2
ON CTHDTHUCUONG
FOR UPDATE
AS
	DECLARE @SOLUONG INT
	SET @SOLUONG = (SELECT SOLUONG FROM INSERTED)
	UPDATE THUCUONG
	SET SOLUONG = THUCUONG.SOLUONG - (@SOLUONG - (SELECT SOLUONG FROM DELETED))
	FROM INSERTED
	WHERE THUCUONG.MATU = INSERTED.MATU
GO

---TEST BẢNG CTHDTU---
UPDATE CTHDTHUCUONG
SET SOLUONG = 27
WHERE MAHD = 'HD001' AND MATU = 'TU011'

SELECT * FROM THUCUONG
SELECT * FROM CTHDTHUCUONG

------====== 10. CẬP NHẬT SOLUONG LẠI CHO BẢNG ĐIỂM TÂM MỖI KHI ĐIỂM TÂM ĐƯỢC BÁN RA (THÊM, SỬA DỮ LIỆU VÀO BẢNG CTHDDIEMTAM) ======------
------INSERT------
CREATE TRIGGER CAPNHATSOLUONGDIEMTAM1
ON CTHDDIEMTAM
FOR INSERT
AS
	DECLARE @SL INT 
	SET @SL = (SELECT SOLUONG FROM INSERTED)
	UPDATE DIEMTAM
	SET SOLUONG = DIEMTAM.SOLUONG - @SL
	FROM INSERTED
	WHERE DIEMTAM.MADT = INSERTED.MADT
GO

---TEST BẢNG CTHDDT---
INSERT INTO DIEMTAM VALUES
('DT011',N'BÚN RIÊU CUA',127,NULL,28000)

INSERT INTO CTHDDIEMTAM VALUES
('HD001','DT011',3,NULL)

SELECT * FROM DIEMTAM
SELECT * FROM CTHDDIEMTAM

------UPDATE------
CREATE TRIGGER CAPNHATSOLUONGDIEMTAM2
ON CTHDDIEMTAM
FOR UPDATE
AS
	DECLARE @SL INT 
	SET @SL = (SELECT SOLUONG FROM INSERTED)
	UPDATE DIEMTAM
	SET SOLUONG = DIEMTAM.SOLUONG - (@SL - (SELECT SOLUONG FROM DELETED))
	FROM INSERTED
	WHERE DIEMTAM.MADT = INSERTED.MADT
GO

---TEST BẢNG CTHDDT---
UPDATE CTHDDIEMTAM
SET SOLUONG = 27
WHERE MAHD = 'HD001' AND MADT = 'DT011'

SELECT * FROM DIEMTAM
SELECT * FROM CTHDDIEMTAM
----------======== 11. CẬP NHẬT LUONGBITRU NẾU: (SONGAYNGHI  < 2 THÌ LUONGBITRU = 0, SONGAYNGHI =2 THÌ LUONGBITRU = 50K, SONGAYNGHI>2 THÌ  LUONGBITRU = 100K) ======---------------
GO
CREATE TRIGGER UP_TRULUONG
ON LUONG
FOR INSERT,UPDATE
AS
BEGIN
	UPDATE LUONG
	SET LUONGBITRU = 
	CASE
	    WHEN INSERTED.SONGAYNGHI < 2 THEN 0
		WHEN INSERTED.SONGAYNGHI = 2 THEN 50000
		WHEN INSERTED.SONGAYNGHI > 2 THEN 100000
	END
	FROM INSERTED JOIN LUONG ON INSERTED.MANV = LUONG.MANV
END
SELECT* FROM LUONG
SELECT* FROM NHANVIEN
INSERT INTO NHANVIEN VALUES
('NV010',N'TRƯƠNG ANH TÀI','12/08/1992',N'QUÃNG NGÃI',N'NAM',NULL,'CV001')
INSERT INTO LUONG VALUES
('NV010','CV001',3,NULL,NULL,NULL,NULL)


------===============RÀNG BUỘC TOÀN VẸN KẾT THÚC Ở ĐÂY==================------------------------
---------=========******* THỦ TỤC  *******=========---------
------====== 1. VIẾT THỦ TỤC TRUYỀN VÀO CA SẼ XUẤT RA MÀN HÌNH DANH SÁCH NHÂN VIÊN LÀM CA ĐÓ  ======------
CREATE PROC XUATDANHSACHCA @CA INT
AS
BEGIN
	SELECT * 
	FROM NHANVIEN
	WHERE CA = @CA
END
GO

---TEST THỦ TỤC---
EXEC XUATDANHSACHCA 1

------====== 2. VIẾT THỦ TỤC TRUYỀN VÀO THAM SỐ TÊN CHỨC VỤ SẼ TRẢ VỀ DANH SÁCH NHỮNG NHÂN VIÊN CÓ CHỨC VỤ THUỘC CHỨC VỤ ĐÓ ======------
CREATE PROC XUATTENCHUCVU @TENCHUCVU NVARCHAR(50)
AS
BEGIN
	SELECT NHANVIEN.*
	FROM NHANVIEN, CHUCVU
	WHERE NHANVIEN.MACV = CHUCVU.MACV AND CHUCVU.TENCHUCVU = @TENCHUCVU
END
GO

---TEST THỦ TỤC---
EXEC XUATTENCHUCVU N'NHÂN VIÊN'

------====== 3. VIẾT THỦ TỤC CẬP NHẬT THUONG TRONG BẢNG LUONG. THUONG = 20000 NẾU NHÂN VIÊN ĐÓ BÁN >= 2 HÓA ĐƠN, THUONG = 0 NẾU <2 HÓA ĐƠN ======------
------====== THUONG = 50000 NẾU NHÂN VIÊN ĐÓ BÁN >= 4 HÓA ĐƠN, THUONG = 100000 NẾU NHÂN VIÊN ĐÓ BÁN >= 6 HÓA ĐƠN ======------
GO
CREATE PROC CAPNHATTHUONG
AS
BEGIN
	UPDATE LUONG
	SET THUONG = 
	CASE
		WHEN  TVSHD.SOHD <2 THEN 0
		WHEN  TVSHD.SOHD >= 2 THEN 20000
		WHEN  TVSHD.SOHD  >= 4 THEN 50000
		WHEN  TVSHD.SOHD  >= 6 THEN 100000
		
	END
	FROM (SELECT MANV,COUNT(*) AS'SOHD' FROM HOADON GROUP BY MANV)TVSHD
	WHERE LUONG.MANV = TVSHD.MANV	
END

EXEC CAPNHATTHUONG

SELECT * FROM LUONG
SELECT * FROM HOADON

------====== 4. VIẾT THỦ TỤC CẬP NHẬT TROCAP TRONG BẢNG LUONG, NHANVIEN THÌ TROCAP = 50000, THUNGAN THÌ TROCAP = 20000, QUANLI THÌ TROCAP = 100000 ======------
CREATE PROC CAPNHATTROCAP
AS
BEGIN
	UPDATE LUONG
	SET TROCAP =
	CASE
		WHEN TENCHUCVU = N'NHÂN VIÊN' THEN 50000
		WHEN TENCHUCVU = N'THU NGÂN' THEN 20000
		WHEN TENCHUCVU = N'QUẢN LÍ' THEN 100000
	END
	FROM NHANVIEN, CHUCVU
	WHERE NHANVIEN.MACV = CHUCVU.MACV AND LUONG.MANV = NHANVIEN.MANV
END

---TEST THỦ TỤC---
EXEC CAPNHATTROCAP

SELECT * FROM LUONG
SELECT * FROM NHANVIEN
SELECT * FROM CHUCVU

------====== 5. VIẾT THỦ TỤC CHO BIẾT THỨC UỐNG NÀO BÁN CHẠY NHẤT (TỔNG SOLUONG TRONG BẢNG CTHDTU NHIỀU NHẤT) ======------
CREATE PROC THUCUONGBANCHAYNHAT
AS
BEGIN
	SELECT THUCUONG.MATU, TENTU,SUM(CTHDTHUCUONG.SOLUONG)
		AS N'SỐ LƯỢNG THỨC UỐNG BÁN CHẠY NHẤT'
	FROM CTHDTHUCUONG, THUCUONG
	WHERE CTHDTHUCUONG.MATU = THUCUONG.MATU  
	GROUP BY THUCUONG.MATU, TENTU, CTHDTHUCUONG.MATU 
	HAVING SUM(CTHDTHUCUONG.SOLUONG) >= ALL (SELECT SUM(SOLUONG) 
		FROM CTHDTHUCUONG GROUP BY MATU)
END

EXEC THUCUONGBANCHAYNHAT
SELECT * FROM CTHDTHUCUONG

------====== 6. VIẾT THỦ TỤC CHO BIẾT ĐIỂM TÂM NÀO BÁN CHẠY NHẤT (TỔNG SOLUONG TRONG BẢNG CTHDDT NHIỀU NHẤT) ======------
CREATE PROC DIEMTAMBANCHAYNHAT
AS
BEGIN
	SELECT DIEMTAM.MADT, TENDT,SUM(CTHDDIEMTAM.SOLUONG) 
	AS N'SỐ LƯỢNG ĐIỂM TÂM BÁN CHẠY NHẤT'
	FROM CTHDDIEMTAM, DIEMTAM
	WHERE CTHDDIEMTAM.MADT = DIEMTAM.MADT  
	GROUP BY DIEMTAM.MADT, TENDT, CTHDDIEMTAM.MADT 
	HAVING SUM(CTHDDIEMTAM.SOLUONG) >= ALL (SELECT SUM(SOLUONG) 
	FROM CTHDDIEMTAM GROUP BY MADT)
END

EXEC DIEMTAMBANCHAYNHAT
SELECT * FROM CTHDDIEMTAM




------======= 7. VIẾT THỦ TỤC CẬP NHẬT TIENBAN TRONG BẢNG HOADON DỰA TRÊN CTHDTU VÀ CTHDDT ======--------------------

GO
CREATE PROC UP_TIENBAN_HD
AS
BEGIN
	UPDATE HOADON
	SET TIENBAN = 0
	UPDATE HOADON
	SET TIENBAN = TTDIEMTAM.TONGTIEN
	FROM (SELECT MAHD,SUM(THANHTIEN) AS'TONGTIEN' FROM CTHDDIEMTAM GROUP BY MAHD)TTDIEMTAM
	WHERE HOADON.MAHD = TTDIEMTAM.MAHD 
	UPDATE HOADON
	SET TIENBAN += TTTHUCUONG.TONGTIEN
	FROM  (SELECT MAHD,SUM(THANHTIEN) AS'TONGTIEN' FROM CTHDTHUCUONG GROUP BY MAHD)TTTHUCUONG
	WHERE TTTHUCUONG.MAHD = HOADON.MAHD
END

EXEC UP_TIENBAN_HD

SELECT * FROM HOADON
SELECT MAHD,SUM(THANHTIEN) AS'TONGTIEN' FROM CTHDDIEMTAM GROUP BY MAHD
SELECT MAHD,SUM(THANHTIEN) AS'TONGTIEN' FROM CTHDTHUCUONG GROUP BY MAHD

------========= 8. VIẾT THỦ TỤC CẬP NHẬT GIAMGIA DỰA TRÊN TIENBAN CỦA HOADON: NẾU TIENBAN > 300K THÌ GIAMGIA 5%, TIENBAN > 500K THÌ GIAMGIA 10% ====---------

GO
CREATE PROC UP_DISCOUNT_HD
AS
BEGIN
	UPDATE HOADON
	SET GIAMGIA =
	CASE 
		WHEN TIENBAN >= 300000 THEN 0.05
		WHEN TIENBAN >= 500000 THEN 0.1
		WHEN TIENBAN < 300000 THEN 0 
	END
END

EXEC UP_DISCOUNT_HD
SELECT * FROM HOADON

------========= 9. VIẾT THỦ TỤC CẬP NHẬT THÀNH TIỀN TRONG BẢNG HOADON DỰA TRÊN TIENBAN VÀ GIAMGIA -------==============
GO
CREATE PROC UP_TT_HOADON
AS
BEGIN
	UPDATE HOADON
	SET THANHTIEN = TIENBAN - TIENBAN * GIAMGIA
END

EXEC UP_TT_HOADON
SELECT * FROM HOADON

-----====== 10. VIẾT THỦ TỤC CẬP NHẬT TÌNH TRẠNG CHO THUCUONG VÀ DIEMTAM. “CÒN” NẾU SOLUONG > 0, “HẾT HÀNG” NẾU SOLUONG = 0 ========------------
GO
CREATE PROC UP_STATUS_TU_DT
AS
BEGIN
	UPDATE DIEMTAM
	SET TINHTRANG =  
	CASE
	 WHEN SOLUONG >0 THEN N'CÒN'
	 WHEN SOLUONG <=0 THEN N'HẾT HÀNG'
	END
	UPDATE THUCUONG
	SET TINHTRANG =  
	CASE
	 WHEN SOLUONG >0 THEN N'CÒN'
	 WHEN SOLUONG <=0 THEN N'HẾT HÀNG'
	END
END 

EXEC UP_STATUS_TU_DT

SELECT * FROM DIEMTAM
SELECT * FROM THUCUONG

--------============ 11. VIẾT THỦ TỤC TÍNH TONGLUONG = LCB + LCB * HSL + THUONG + TROCAP. LCB VÀ HSL TRONG BẢNG CHỨC VỤ  =====-------------
GO
CREATE PROC UP_TONGLUONG_LUONG
AS
BEGIN
	UPDATE LUONG
	SET TONGLUONG =  TVCV.LUONGCB + TVCV.LUONGCB * TVCV.HSL + THUONG + TROCAP - LUONGBITRU
	FROM (SELECT CHUCVU.MACV,LUONGCB,HSL FROM CHUCVU JOIN LUONG ON CHUCVU.MACV = LUONG.MACV)TVCV
	WHERE LUONG.MACV = TVCV.MACV
END

EXEC UP_TONGLUONG_LUONG

SELECT * FROM CHUCVU
SELECT * FROM LUONG

-----============== 12. VIẾT THỦ TỤC CHO BIẾT HOADON NÀO CÓ SỐ LƯỢNG ĐIỂM TÂM NHIỀU NHẤT ======-----------------
GO
CREATE PROC HD_MOST_DIEMTAM @MAHD VARCHAR(10) OUTPUT
AS
BEGIN
	SET @MAHD = (SELECT  MAHD FROM CTHDDIEMTAM GROUP BY MAHD
					HAVING SUM(SOLUONG)>= ALL(SELECT SUM(SOLUONG) FROM CTHDDIEMTAM GROUP BY MAHD))
END

DECLARE @MAHD VARCHAR(10)
EXEC HD_MOST_DIEMTAM @MAHD OUTPUT
SELECT @MAHD AS'HD CÓ NHIỀU ĐIỂM TÂM NHẤT'
------============ 13. VIẾT THỦ TỤC CHO BIẾT HOADON CÓ SỐ LƯỢNG THỨC UỐNG NHIỀU NHẤT ========---------------
GO
CREATE PROC HD_MOST_THUCUONG @MAHD VARCHAR(10) OUTPUT
AS
BEGIN
	SET @MAHD = (SELECT  MAHD FROM CTHDTHUCUONG GROUP BY MAHD
					HAVING SUM(SOLUONG) >= ALL(SELECT SUM(SOLUONG) FROM CTHDTHUCUONG GROUP BY MAHD))
END

DECLARE @MAHD VARCHAR(10)
EXEC HD_MOST_THUCUONG @MAHD OUTPUT
SELECT @MAHD AS'HD CÓ NHIỀU THỨC UỐNG NHẤT'

----======= 14. VIẾT THỦ TỤC CHO BIẾT HOADON NÀO CÓ TIENBAN CAO NHẤT (PROC) ========----------------
GO
CREATE PROC HD_MOST_EXPENSIVE @MAHD VARCHAR(10) OUTPUT
AS
BEGIN
	SET @MAHD = (SELECT MAHD FROM HOADON WHERE TIENBAN >= ALL(SELECT TIENBAN FROM HOADON))
END
drop proc HD_MOST_EXPENSIVE
DECLARE @MHD VARCHAR(10) 
EXEC HD_MOST_EXPENSIVE @MHD OUTPUT
SELECT @MHD AS ' HÓA ĐƠN CÓ TIỀN BÁN CAO NHẤT'

------=========== 15. VIẾT THỦ TỤC CHO BIẾT NHỮNG THỨC UỐNG NÀO BÁN CHẬM NHẤT (TỔNG SOLUONG TRONG BẢNG CTHDTU ÍT NHẤT) ========-------------
GO
CREATE PROC SLOWEST_DRINK
AS
BEGIN
	SELECT * FROM THUCUONG WHERE MATU IN (SELECT MATU FROM CTHDTHUCUONG 
		GROUP BY MATU 
			HAVING SUM(SOLUONG) <= ALL(SELECT SUM(SOLUONG) 
				FROM CTHDTHUCUONG GROUP BY MATU))
END

EXEC SLOWEST_DRINK

----======== 16. VIẾT THỦ TỤC CHO BIẾT NHỮNG ĐIỂM TÂM NÀO BÁN CHẬM NHẤT (TỔNG SOLUONG TRONG BẢNG CTHDDT ÍT NHẤT) ========---------
GO
CREATE PROC SLOWEST_FOOD
AS
BEGIN
	SELECT * FROM DIEMTAM WHERE MADT IN (SELECT MADT FROM CTHDDIEMTAM 
		GROUP BY MADT 
			HAVING SUM(SOLUONG) <= ALL(SELECT SUM(SOLUONG) FROM CTHDDIEMTAM GROUP BY MADT))
END

EXEC SLOWEST_FOOD
select*from DIEMTAM

------===============PROC KẾT THÚC Ở ĐÂY==================------------------------

-----=================*******HÀM*******=================-------------------------

-----============ 1. TRUYỀN VÀO THAM SỐ MAKH,  IN RA DANH SÁCH CÁC HÓA ĐƠN(MAHD, THANHTIEN) ======-------------
GO
CREATE FUNCTION LIST_HD (@MAKH VARCHAR(10))
RETURNS @TABLE_LISTHD TABLE(MAHD NVARCHAR(10),THANHTIEN FLOAT)
AS
BEGIN
 INSERT INTO @TABLE_LISTHD
 SELECT MAHD,THANHTIEN
 FROM HOADON
 WHERE HOADON.MAKH = @MAKH
 RETURN
END

SELECT * FROM DBO.LIST_HD ('KH001')
----========= 2. TRUYỀN VÀO THAM SỐ MAHD, TRẢ VỀ NGAYLAP VÀ THANHTIEN CỦA HÓA ĐƠN ĐÓ ====---------------
GO
CREATE FUNCTION DATE_MONEY (@MAHD VARCHAR(10))
RETURNS @TABLE_DATE_MONEY TABLE(NGAY DATE,THANHTIEN FLOAT)
AS
BEGIN
	INSERT INTO @TABLE_DATE_MONEY
	SELECT NGAYLAP,THANHTIEN
	FROM HOADON
	WHERE HOADON.MAHD = @MAHD
	RETURN
END

SELECT * FROM DBO.DATE_MONEY('HD001')

------------========= 3. TRUYỀN VÀO THAM SỐ NGAYLAP, IN RA DANH SÁCH NHỮNG HOADON ĐƯỢC LẬP CÙNG NGÀY =======-----------

GO
CREATE FUNCTION LIST_HD_SAME_DATE (@NGAYLAP DATE)
RETURNS @TABLE_LISTHD TABLE(MAHD VARCHAR(10))
AS
BEGIN
	INSERT INTO @TABLE_LISTHD
	SELECT MAHD
	FROM HOADON
	WHERE NGAYLAP = @NGAYLAP
	RETURN
END

SET DATEFORMAT DMY
SELECT * FROM DBO.LIST_HD_SAME_DATE ('30/07/2019')
----======== 4. TRUYỀN VÀO THAM SỐ MANV, CHO BIẾT MAHD, NGAYLAP, THANH TIEN CỦA HÓA ĐƠN MÀ NHÂN VIÊN ĐÓ PHỤ TRÁCH ======-----------
GO
CREATE FUNCTION HD_DATE_MONEY (@MANV VARCHAR(10))
RETURNS @TABLE_NV_HD TABLE(MAHD VARCHAR(10),NGAYLAP DATE,THANHTIEN FLOAT)
AS
BEGIN
	INSERT INTO @TABLE_NV_HD
	SELECT MAHD,NGAYLAP,THANHTIEN
	FROM HOADON
	WHERE MANV = @MANV
	RETURN
END

SELECT * FROM DBO.HD_DATE_MONEY('NV004')
---------======= 5. TRUYỀN VÀO THAM SỐ DIACHI, IN RA DANH SÁCH CÁC NHÂN VIÊN THUỘC ĐỊA CHỈ ĐÓ ===============--------------
GO
CREATE FUNCTION LIST_NV (@DIACHI NVARCHAR(50))
RETURNS @TABLE_NV TABLE (MANV NVARCHAR(10),
	HOTENNV NVARCHAR(50),
	NGAYSINH DATE,
	GIOITINH NVARCHAR(10))
AS
BEGIN
	INSERT INTO @TABLE_NV
	SELECT MANV,HOTENNV,NGAYSINH,GIOITINH FROM NHANVIEN
	WHERE DIACHI = @DIACHI
	RETURN
END

SELECT * FROM DBO.LIST_NV(N'TP.HCM')
select*from NHANVIEN
---------============= 6. TRUYỀN THAM SỐ MÃ ĐỒ UỐNG VÀO, CHO BIẾT SỐ LƯỢNG ĐÃ BÁN CỦA ĐỒ UỐNG ================-------------
GO
CREATE FUNCTION THUCUONG_SOLUONG_DABAN (@MADU VARCHAR(10))
RETURNS INT 
AS
BEGIN
	RETURN (SELECT SUM(SOLUONG) FROM CTHDTHUCUONG WHERE MATU = @MADU )
END

DECLARE @SOLUONG INT
SET @SOLUONG = DBO.THUCUONG_SOLUONG_DABAN('TU002')
SELECT @SOLUONG AS ' SỐ LƯỢNG THỨC UỐNG ĐÃ BÁN'
-------============ 7. TRUYỀN THAM SỐ MÃ ĐIỂM TÂM VÀO,CHO BIẾT SỐ LƯỢGN ĐÃ BÁN CỦA ĐIỂM TÂM ===================-------------------------
GO
CREATE FUNCTION DIEMTAM_SOLUONG_DABAN (@MADT VARCHAR(10))
RETURNS INT 
AS
BEGIN
	RETURN (SELECT SUM(SOLUONG) FROM CTHDDIEMTAM WHERE MADT = @MADT )
END

DECLARE @SOLUONG INT
SET @SOLUONG = DBO.DIEMTAM_SOLUONG_DABAN('DT004')
SELECT @SOLUONG AS ' SỐ LƯỢNG ĐIỂM TÂM ĐÃ BÁN'
-----------============== 8. TRUYỀN THAM SỐ NGÀY X , LIỆT KÊ DANH SÁCH CÁC MÓN ĐIỂM TÂM , THỨC UỐNG ĐÃ BÁN TRONG NGÀY ĐÓ ( TÊN THỨC UỐNG, TÊN ĐIỂM TÂM, MÃ  ĐTÂM, MÃ THỨC UỐNG) =======================---------------------------
GO
CREATE FUNCTION LIST_ORDER_DATE(@NGAYBAN DATE)
RETURNS @TABLE_LIST_ORDER TABLE (MADT VARCHAR(10),TENDT NVARCHAR(50),MATU VARCHAR(10),TENTU NVARCHAR(50))
AS
BEGIN
	INSERT INTO @TABLE_LIST_ORDER
	SELECT DIEMTAM.MADT,DIEMTAM.TENDT,THUCUONG.MATU,THUCUONG.TENTU FROM HOADON
								  LEFT JOIN CTHDDIEMTAM ON HOADON.MAHD = CTHDDIEMTAM.MAHD
								  LEFT JOIN DIEMTAM ON CTHDDIEMTAM.MADT = DIEMTAM.MADT
								  LEFT JOIN CTHDTHUCUONG  ON HOADON.MAHD = CTHDTHUCUONG.MAHD
								  LEFT JOIN THUCUONG ON CTHDTHUCUONG.MATU = THUCUONG.MATU
								  WHERE NGAYLAP = @NGAYBAN
	RETURN
END

SET DATEFORMAT DMY
SELECT * FROM DBO.LIST_ORDER_DATE ('30/07/2019')
----===========*HÀM KẾT THÚC TẠI ĐÂY*=========------------------
SELECT * FROM NHANVIEN
SELECT * FROM CHUCVU
SELECT * FROM KHACHHANG
SELECT * FROM THUCUONG
SELECT * FROM DIEMTAM
SELECT * FROM CTHDDIEMTAM
SELECT * FROM CTHDTHUCUONG
SELECT * FROM HOADON
SELECT * FROM LUONG
DROP DATABASE DEAN_JAVA



------------------------------------------------------------------------
BACKUP DATABASE DEAN_JAVA
TO DISK = 'D:\Backup\DEAN_JAVA_FULL.BAK'
WITH INIT
-----9AM : DIFFERENTIAL BACKUP

BACKUP DATABASE DEAN_JAVA
TO DISK = 'D:\Backup\DEAN_JAVA_DIFF.bak'
with INIT,DIFFERENTIAL 
-----10AM: LOG BACKUP LẦN 1 TRONG NGÀY

BACKUP LOG DEAN_JAVA
TO DISK = 'D:\Backup\DEAN_JAVA_TRAN.trn'
with init

----3PM : LOG BACKUP LẦN 2 TRONG NGÀY

BACKUP LOG DEAN_JAVA
TO DISK = 'D:\Backup\DEAN_JAVA_TRAN.trn'

----6PM : DIFFERENTIAL BACKUP lần 2 
BACKUP DATABASE DEAN_JAVA
TO DISK = 'D:\Backup\DEAN_JAVA_DIFF.bak'
WITH DIFFERENTIAL 

----7PM : LOG BACKUP LẦN CUỐI 
BACKUP LOG DEAN_JAVA
TO DISK = 'D:\Backup\DEAN_JAVA_TRAN.trn'

------------------------------------------

RESTORE DATABASE DEAN_JAVA
FROM DISK ='D:\Backup\DEAN_JAVA_FULL.BAK'
WITH NORECOVERY

--------B2 KHÔI PHỤ TỪ BẢN DIFFERENTIAL BACKUP GẦN LẦN XẢY RA SỰ CAOOS NHẤT VÀO 9PM NGÀY T4 NHẤT LÀ 9AM CỦA NGÀY THỨ 5
RESTORE DATABASE DEAN_JAVA
FROM DISK = 'D:\Backup\DEAN_JAVA_DIFF.BAK'
WITH NORECOVERY

-----B3 KHÔI PHỤC TẤT CẢ BẢN LOG BACKUP TỪ LẦN DIFF BACKUP LÚC 9PM NGÀY T5 ĐẾN 4PM NGÀY T5 LÀ CÁC LOG 10AM VÀ 3PM

--------BẢN 10AM
RESTORE DATABASE DEAN_JAVA
FROM DISK = 'D:\Backup\DEAN_JAVA_TRAN.trn'
WITH FILE = 1,NORECOVERY
------BẢN 3PM
RESTORE DATABASE DEAN_JAVA
FROM DISK = 'D:\Backup\DEAN_JAVA_TRAN.trn'
WITH FILE = 1,RECOVERY

use DEAN_JAVA
SELECT * FROM sys.databases

DELETE THUCUONG
WHERE MATU = 'TU011'



------------------------ THÊM TỪ DƯỚI NÀY 
------------- TRIGGER DELETE KHÓA NGOẠI
CREATE TRIGGER DEL_TU
ON THUCUONG
INSTEAD OF DELETE
AS
BEGIN
	DELETE CTHDTHUCUONG
	WHERE MATU = (SELECT MATU FROM deleted)
	DELETE THUCUONG
	WHERE MATU = (SELECT MATU FROM DELETED)
END

CREATE TRIGGER DEL_DT
ON DIEMTAM
INSTEAD OF DELETE
AS
BEGIN
	DELETE CTHDDIEMTAM
	WHERE MADT = (SELECT MADT FROM deleted)
	DELETE DIEMTAM
	WHERE MADT = (SELECT MADT FROM DELETED)
END
------------------------ PROC TÌM KIẾM 
GO
create PROC FIND_TU @PARA NVARCHAR(100)
AS
BEGIN
	SELECT * FROM THUCUONG
	WHERE MATU = @PARA OR TENTU LIKE '%' + @PARA + '%' 
end

create proc SHOWTU
as
begin
SELECT * FROM THUCUONG
end


exec FIND_TU N'Pepsi' 


GO
CREATE PROC FIND_DT @PARA NVARCHAR(100)
AS
BEGIN
	SELECT * FROM DIEMTAM
	WHERE MADT = @PARA OR TENDT LIKE '%' + @PARA + '%' OR CONVERT(NVARCHAR(30),SOLUONG) =@PARA OR CONVERT(NVARCHAR(30),DONGIA)=@PARA
END
